CC = gcc
AR = ar
CP = cp
ARMCC = arm-elf-gcc
ARMAS = arm-elf-as
OBJCOPY = arm-elf-objcopy
UNAME := $(shell uname -s)
BIN2C = ../../tools/bin2c
INCLUDE = -I./../..

PAYLOAD_TARGET = payload.h
PAYLOAD_OBJECTS = limera1n.S $(BIN2C)

LIMERA1N_TARGET = limera1n.o
LIMERA1N_OBJECTS = limera1n.c $(PAYLOAD_TARGET)

TARGETS = $(PAYLOAD_TARGET) $(LIMERA1N_TARGET)

ifeq ($(UNAME),Darwin)
	CFLAGS = -I./include -I./resources -I/usr/local/include -I/opt/local/include# -mmacosx-version-min=10.5 -arch i386 -isysroot /Developer/SDKs/MacOSX10.5.sdk
	LDFLAGS = -L/usr/lib -L/opt/local/lib -lusb-1.0 -lcurl -lz -framework CoreFoundation -framework IOKit# -mmacosx-version-min=10.5 -arch i386 -isysroot /Developer/SDKs/MacOSX10.5.sdk -Wl,-no_compact_linkedit
	ADDOBJ = 
else
	ifeq ($(UNAME),MINGW32_NT-5.1)
		CFLAGS = -O3 -I./resources -DCURL_STATICLIB
		LDFLAGS = -lcurl -lz
		ADDOBJ = /mingw/lib/libcurl.a /mingw/lib/libwsock32.a /mingw/lib/libwldap32.a /mingw/lib/libpenwin32.a /mingw/lib/libz.a /mingw/lib/libsetupapi.a
	else
		CFLAGS = -O3 -I./resources -I./include
		LDFLAGS = -lusb-1.0 -lcurl -lz
		ADDOBJ = 
	endif
endif

CFLAGS += -I../../

all: $(TARGETS)

$(PAYLOAD_TARGET): $(PAYLOAD_OBJECTS)
	$(ARMAS) -mthumb -o payload.o $<
	$(OBJCOPY) -O binary payload.o payload.bin
	$(BIN2C) payload.bin payload.h limera1n
	
$(LIMERA1N_TARGET): $(LIMERA1N_OBJECTS)
	$(CC) -c $< -o $@ $(INCLUDES) $(CFLAGS)

clean:
	rm -rf *.o *.bin
